<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>×”×©×•×•××ª ××—×™×¨×™ ×¡×œ ×§× ×™×•×ª</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { background: #f8f9fa; }
    .container { max-width: 900px; margin-top: 40px; }
    textarea { font-size: 0.95rem; }
    .spinner-border { display: none; vertical-align: middle; }
    .badge-sub { background: #ffe08a; color: #3b3b00; }
    .muted { color: #6c757d; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="mb-3">×”×©×•×•××ª ×¡×œ ×§× ×™×•×ª ×‘×¡×•×¤×¨××¨×§×˜×™×</h1>
    <p class="text-muted">
      ×›×ª×‘×• ××ª ×¨×©×™××ª ×”×§× ×™×•×ª <strong>×‘×˜×§×¡×˜ ×—×•×¤×©×™</strong> (×œ× ×—×™×™×‘ ×¤×¡×™×§×™×/×©×•×¨×•×ª). ×œ×“×•×’××”:
      <span class="mono">×©×™×©×™×™×ª ××™× 1.5 ×œ×™×˜×¨, 10 ×¤×™×ª×•×ª, ×—×œ×‘ 3 ××—×•×– 2, ×§×•×§×” ×§×•×œ×” ×‘×§×‘×•×§×™× 2</span>
    </p>

    <form id="searchForm" class="card p-3 shadow-sm">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">×›×ª×•×‘×ª / ×¢×™×¨</label>
          <input type="text" class="form-control" id="address" required placeholder="×œ××©×œ: ×—×•×œ×•×Ÿ" />
        </div>
        <div class="col-md-3">
          <label class="form-label">×¨×“×™×•×¡ (×‘×§×´×)</label>
          <input type="number" class="form-control" id="radius" required min="1" step="0.5" value="5" />
        </div>
        <div class="col-12">
          <label class="form-label">×¨×©×™××ª ×§× ×™×•×ª (×˜×§×¡×˜ ×—×•×¤×©×™)</label>
          <textarea id="shoppingList" class="form-control" rows="4" required
            placeholder="×œ×“×•×’××”: ×©×™×©×™×™×ª ××™× 1.5 ×œ×™×˜×¨, 10 ×¤×™×ª×•×ª, 2 ×—×œ×‘ 3%, ×§×•×§×” ×§×•×œ×” 2 ×‘×§×‘×•×§×™×, ×¡×¤×’×˜×™"></textarea>
          <div class="form-text">
            ××™×Ÿ ×—×•×‘×” ×œ×”×¤×¨×™×“ ×‘×¤×¡×™×§×™× â€” ×”××¢×¨×›×ª ×ª× ×¡×” ×œ×”×‘×™×Ÿ ××•×¦×¨×™× ×•×›××•×™×•×ª ×’× ×××©×¤×˜ ×—×•×¤×©×™.
          </div>
        </div>
      </div>

      <div class="mt-3 d-flex align-items-center">
        <button type="submit" class="btn btn-primary">
          ××¦× ×œ×™ ××ª ×”×–×•×œ ×‘×™×•×ª×¨
        </button>
        <div class="spinner-border text-primary ms-3" role="status" id="loading">
          <span class="visually-hidden">×˜×•×¢×Ÿ...</span>
        </div>
      </div>
    </form>

    <div id="results" class="mt-4"></div>
  </div>

  <script>
    const form = document.getElementById("searchForm");
    const resultsDiv = document.getElementById("results");
    const spinner = document.getElementById("loading");

    function esc(s) {
      return String(s ?? "").replace(/[&<>"'`=\/]/g, (c) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"
      }[c]));
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      resultsDiv.innerHTML = "";
      spinner.style.display = "inline-block";

      const address = document.getElementById("address").value.trim();
      const radius = parseFloat(document.getElementById("radius").value);
      const listText = document.getElementById("shoppingList").value.trim();

      try {
        const resp = await fetch("/api/search", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            address,
            radius_km: radius,
            list_text: listText // ğŸ‘ˆ ×©×•×œ×—×™× ×˜×§×¡×˜ ×—×•×¤×©×™. ×”-LLM ×¢×•×©×” ×”×›×œ.
          })
        });

        const data = await resp.json();
        spinner.style.display = "none";

        if (!resp.ok) {
          resultsDiv.innerHTML = `<div class="alert alert-danger">×©×’×™××ª ×©×¨×ª (${resp.status}): ${esc(data.message || "×œ× ×™×“×•×¢")}</div>`;
          return;
        }

        if (data.status === "ok") {
          if (!Array.isArray(data.results) || data.results.length === 0) {
            resultsDiv.innerHTML = `<div class="alert alert-info">×œ× × ××¦××• ×ª×•×¦××•×ª.</div>`;
            return;
          }

          // ××¦×™×’×™× ××ª ×”×ª×•×¦××•×ª ×‘×“×™×•×§ ×œ×¤×™ ×”×¡×“×¨ ×©×”-LLM ×”×—×–×™×¨ (×××•×¨ ×œ×”×™×•×ª ××”×–×•×œ ×œ×™×§×¨)
          let html = "";
          data.results.forEach(r => {
            const currency = esc(r.currency || "â‚ª");
            const mo = (r.match_overall != null && !Number.isNaN(r.match_overall))
              ? `${Math.round(Number(r.match_overall) * 100)}%`
              : "â€”";

            const basketRows = Array.isArray(r.basket) ? r.basket.map(b => {
              const subBadge = b.substitution ? ' <span class="badge badge-sub rounded-pill">×ª×—×œ×™×£</span>' : '';
              const conf = (b.match_confidence != null && !Number.isNaN(b.match_confidence))
                ? `${Math.round(Number(b.match_confidence) * 100)}%` : "â€”";
              const unit = Number(b.unit_price || 0);
              const line = Number(b.line_total || 0);
              return `
                <tr>
                  <td>${esc(b.name)}${subBadge}</td>
                  <td>${esc(b.quantity)}</td>
                  <td>${unit.toFixed(2)}</td>
                  <td>${line.toFixed(2)}</td>
                  <td>${conf}</td>
                </tr>`;
            }).join("") : "";

            html += `
              <div class="card mb-3 shadow-sm">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <h5 class="card-title mb-1">#${esc(r.rank)} â€” ${esc(r.store_name)}</h5>
                      <div class="text-muted small">
                        ${esc(r.address)} | ××¨×—×§: ${esc(r.distance_km)} ×§×´× | ×“×™×•×§ ×›×œ×œ×™: ${mo}
                      </div>
                    </div>
                    <div class="text-end">
                      <div class="h5 mb-0">×¡×”×´×›: ${Number(r.total_price || 0).toFixed(2)} ${currency}</div>
                      <div class="small text-muted">(××”×–×•×œ ×œ×™×§×¨ â€” ×œ×¤×™ ×”-LLM)</div>
                    </div>
                  </div>

                  <div class="table-responsive mt-3">
                    <table class="table table-sm align-middle">
                      <thead>
                        <tr class="table-light">
                          <th>××•×¦×¨</th>
                          <th>×›××•×ª</th>
                          <th>××—×™×¨ ×™×—×™×“×”</th>
                          <th>×¡×š ×”×›×œ</th>
                          <th>×“×™×•×§</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${basketRows}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>`;
          });

          resultsDiv.innerHTML = html;

        } else if (data.status === "need_input") {
          const missing = Array.isArray(data.needed) ? data.needed.join(", ") : "";
          resultsDiv.innerHTML = `<div class="alert alert-warning">×—×¡×¨×™× ×©×“×•×ª: ${esc(missing)}</div>`;
        } else if (data.status === "no_results") {
          resultsDiv.innerHTML = `<div class="alert alert-info">×œ× × ××¦××• ×ª×•×¦××•×ª.</div>`;
        } else {
          resultsDiv.innerHTML = `<div class="alert alert-danger">×©×’×™××”: ${esc(data.message || "×œ× ×™×“×•×¢")}</div>`;
        }

      } catch (err) {
        spinner.style.display = "none";
        resultsDiv.innerHTML = `<div class="alert alert-danger">×©×’×™××” ×‘×§×¨×™××” ×œ×©×¨×ª: ${esc(err.message)}</div>`;
      }
    });
  </script>
  <!-- Bootstrap JS (××•×¤×¦×™×•× ×œ×™ ×œ×¨×›×™×‘×™× ××¡×•×™××™×) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
