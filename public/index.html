<!DOCTYPE html>
<div class="page">
<div class="box">
<div style="font-weight:800;font-size:20px">רדיוס חיפוש</div>
<div class="muted" id="radiusHelp" style="margin-top:6px">בחר/י כמה ק״מ מסביב לכתובת</div>
<div class="radius-grid" style="margin-top:12px">
<button class="btn-chip" type="button" data-radius="2">2 ק״מ</button>
<button class="btn-chip" type="button" data-radius="5">5 ק״מ</button>
<button class="btn-chip" type="button" data-radius="10">10 ק״מ</button>
<button class="btn-chip" type="button" data-radius="15">15 ק״מ</button>
</div>
<div class="input" style="margin-top:12px">
<label class="muted" for="radius">או הזן/י ידנית</label>
<input id="radius" type="number" min="1" step="0.5" placeholder="5" aria-describedby="radiusHelp" />
</div>
</div>
</div>
</section>


<!-- Screen 4: List -->
<section id="s4" class="screen">
<div class="page">
<div class="box">
<div style="font-weight:800;font-size:20px">מה תרצה לקנות?</div>
<div class="muted" id="listHelp" style="margin-top:6px">טקסט חופשי. ה-AI יבין מוצרים וכמויות.</div>
<div class="input" style="margin-top:12px">
<textarea id="list" rows="5" aria-describedby="listHelp" placeholder="למשל: שישיית מי עדן 1.5 ל׳, חזה עוף 1 ק״ג, 2 קוקה קולה 1.5 ל׳"></textarea>
</div>


<div class="toggle" style="margin-top:8px">
<input type="checkbox" id="verifiedOnly" checked />
<label for="verifiedOnly">הצג רק חנויות מאומתות</label>
</div>
</div>
</div>
</section>


<!-- Screen 5: Results -->
<section id="s5" class="screen">
<div class="page">
<div class="box">
<div style="display:flex;justify-content:space-between;align-items:center">
<div style="font-weight:800;font-size:20px">התוצאות</div>
<span class="pill">OpenAI web_search</span>
</div>
<div id="summary" class="muted" style="margin-top:6px"></div>
<div id="results" style="margin-top:12px" aria-live="polite"></div>
<div id="loading" class="skeleton" style="height:64px;margin-top:12px;display:none" aria-live="polite"></div>


<div id="debugWrap" style="display:none;margin-top:12px">
<details><summary>🔧 Debug</summary><pre id="debugJson" class="debug"></pre></details>
</div>
</div>
</div>
</section>


<div class="cta">
<div class="inner">
<button id="back" class="btn btn-ghost" type="button">חזרה</button>
<button id="next" class="btn btn-black" type="button">הבא</button>
</div>
</div>
</div>


<!-- Modal: How it works -->
<div id="howModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="howTitle">
howModal?.addEventListener('click', (e)=>{ if(e.target===howModal) howModal.classList.remove('active'); });


gpsSoon?.addEventListener('click', ()=> alert('שימוש ב-GPS יתווסף בקרוב 😊'));


document.querySelectorAll('[data-radius]').forEach(b=>{
b.addEventListener('click', ()=>{
setRadius(b.getAttribute('data-radius'));
goto(step+1);
});
});


btnBack.addEventListener('click', ()=>{ if(step===0){ return; } goto(step-1); });


// Keyboard UX
[addressEl, radiusEl].forEach(el=> el.addEventListener('keydown', e=>{ if(e.key==='Enter'){ btnNext.click(); }}));
listEl.addEventListener('keydown', e=>{ if((e.ctrlKey||e.metaKey) && e.key==='Enter'){ btnNext.click(); }});


btnNext.addEventListener('click', async ()=>{
if(step===1){ if(!addressEl.value.trim()) return shake(addressEl); return goto(step+1); }
if(step===2){ if(!radiusEl.value) return shake(radiusEl); return goto(step+1); }
if(step===3){ if(!listEl.value.trim()) return shake(listEl); return goto(step+1); }
if(step<4) return goto(step+1);


// Run search
renderSkeleton();
debugWrap.style.display = isDebug ? 'block' : 'none';
debugJson.textContent = '';


const payload = {
address: addressEl.value.trim(),
radius_km: Number(radiusEl.value || 5),
list_text: listEl.value.trim(),
show_all: !verifiedOnlyEl.checked ? true : false,
include_debug: isDebug
};


summaryEl.textContent = `כתובת: ${payload.address} • רדיוס: ${payload.radius_km} ק״מ • פריטים: ${countItems(payload.list_text)}`;


try{
const res = await apiSearch(payload);
const data = await res.json();


loadingEl.style.display = 'none';
if (isDebug) debugJson.textContent = JSON.stringify(data, null, 2);


if(!res.ok){
const map = {
400: 'קלט לא תקין. נסו לדייק כתובת/רשימה.',
429: 'עומס זמני. נסו שוב בעוד דקה.',
502: 'שגיאה מול ספק חיצוני. נסו שוב.',
500: 'שגיאה בשרת. נסו שוב.'
};
const msg = map[res.status] || (data && data.message) || 'שגיאת שרת לא צפויה.';
resultsEl.innerHTML = row(`שגיאת שרת (${res.status})`, msg);
console.error("API error", data);
return;
}


if (data.status === 'need_input' && Array.isArray(data.needed)){
resultsEl.innerHTML = row('קלט חסר', 'חסר מידע: ' + data.needed.join(', '));
return;
}


if(data.status!=='ok' || !Array.isArray(data.results) || data.results.length===0){
resultsEl.innerHTML = row('לא נמצאו תוצאות', data.message || 'נסו לדייק מותג/נפח, להגדיל רדיוס, או לנסות מיקום סמוך');
return;
}


resultsEl.innerHTML = data.results.map(renderStore).join('');
focusResults();
}catch(err){
const total = toPrice(r.total_price, r.currency || "₪");
const mo = (typeof r.match_overall === 'number') ? `${Math.round(r.match_overall*100)}%` : '—';
const cover = (typeof r.coverage === 'number') ? `${Math.round(r.coverage*100)}%` : '—';


const storeVer = r.store_verification || {};
const verified = !!storeVer.store_verified;
const badge = verified ? `<span class="pill good">מאומת</span>` : `<span class="pill bad">לא מאומת</span>`;


const basketRows = Array.isArray(r.basket) ? r.basket.map(b=>{
const unit = toPrice(b.unit_price, r.currency || "₪");
const line = toPrice(b.line_total, r.currency || "₪");
const brand = b.brand ? ` <span class="muted">• ${esc(b.brand)}</span>` : '';
const src = b.product_url ? `<div class="muted"><a href="${escAttr(safeUrl(b.product_url))}" target="_blank" rel="noopener">מקור</a>${b.source_domain? ' • '+esc(b.source_domain):''}${b.observed_price_text? ' • '+esc(b.observed_price_text): ''}</div>` : '';


const v = b.verification || {};
const vline = `<div class="small ${v.notes==='OK'?'good':'bad'}">
אימות: דומיין ${v.domain_ok?'✅':'❌'} • סטטוס ${v.http_status||0} • ₪/${v.price_source||'-'} ${v.found_shekel?'✅':'❌'} • התאמת מחיר ${v.price_matches?'✅':'❌'} • התאמת שם ~${Math.round((v.name_match||0)*100)}%
</div>`;


const sub = b.substitution ? ` <span class="pill">תחליף</span>` : '';


return `
<div class="row">
<div>
<div><strong>${esc(b.name||'')}</strong>${brand}${sub}</div>
<div class="muted" style="font-size:12px">כמות: ${esc(b.quantity??'')} • נפח/גודל: ${esc(b.size||'-')} • יח': ${esc(b.pack_qty??'-')}</div>
${src}${vline}
</div>
<div class="total">${line}</div>
</div>`;
}).join('') : '';


const hdr = `
<div class="row">
<div>
<div><strong>#${esc(r.rank||'?')} — ${esc(r.store_name||'')}</strong> ${badge}</div>
<div class="muted small">${esc(r.branch_name||'')} • ${esc(r.address||'')} • ${esc(r.distance_km||'')} ק״מ • דיוק כללי ${mo} • כיסוי ${cover}</div>
${r.branch_url ? `<div class="small"><a href="${escAttr(safeUrl(r.branch_url))}" target="_blank" rel="noopener">דף הסניף / מפות</a></div>` : ''}
${r.notes ? `<div class="muted small">${esc(r.notes)}</div>` : ''}
</div>
<div class="total">${total}</div>
</div>
`;


return hdr + `<details class="box" style="margin-top:10px"><summary>פירוט סל</summary><div style="height:8px"></div>${basketRows}</details>`;
}


function renderSkeleton(){ resultsEl.innerHTML=''; loadingEl.style.display='block'; }
function row(title, msg){ return `<div class="row"><div><strong>${esc(title)}</strong><div class="muted" style="font-size:12px">${esc(msg)}</div></div></div>`; }
function shake(el){ el.style.borderColor='#ffb4b4'; el.animate([{transform:'translateX(0)'},{transform:'translateX(-4px)'},{transform:'translateX(4px)'},{transform:'translateX(0)'}],{duration:260}); setTimeout(()=>el.style.borderColor='#e6edf7',320); }
function esc(s){return String(s??'').replace(/[&<>"'`=\/]/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"}[c]))}
function escAttr(s){return String(s??'').replace(/"/g,'&quot;')}
function toPrice(v, currency){
if (typeof v === "number") return v.toFixed(2)+" "+currency;
if (typeof v === "string" && v.trim()) return v.includes("₪") ? v : (v+" "+currency);
return "—";
}
function countItems(list){
return list.split(/\n|,/).map(s=>s.trim()).filter(Boolean).length;
}
function focusResults(){ resultsEl.setAttribute('tabindex','-1'); resultsEl.focus(); }
function setRadius(val){
const v = Math.max(1, Number(val)||5);
radiusEl.value = v;
document.querySelectorAll('[data-radius]').forEach(x=>{
x.dataset.active = (Number(x.dataset.radius)===v) ? "1":"0";
});
}
function safeUrl(u){
try { const url = new URL(u, location.origin); if (!/^https?:$/.test(url.protocol)) return '#'; return url.href; } catch { return '#'; }
}


// Local Storage (state)
const KEY='cartcompa

