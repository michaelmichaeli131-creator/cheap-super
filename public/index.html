<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<title>×”×©×•×•××ª ×¡×œ ×§× ×™×•×ª AI - ××•×¨×—×‘</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
:root{
  --ink:#0d1321;
  --muted:#6b7280;
  --brand:#2fb6ff;
  --bg:#f5f9ff;
  --card:#fff;
  --glass:#ffffffcc;
  --shadow:0 14px 34px rgba(15,50,90,.12);
  --success:#047857;
  --error:#b91c1c;
}
*{box-sizing:border-box;}
html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;}
.app{max-width:480px;margin:0 auto;min-height:100dvh;display:flex;flex-direction:column;overflow:hidden;}
.screen{display:none}.screen.active{display:block;}
.page{padding:0 16px 120px;}
.box{background:var(--card);border-radius:22px;box-shadow:var(--shadow);padding:16px;margin-bottom:20px;}
.muted{color:var(--muted);}
.input{display:flex;flex-direction:column;gap:8px;}
.input input,.input textarea{width:100%;padding:14px;border-radius:16px;border:1px solid #e6edf7;outline:none;box-shadow:0 6px 12px #0b3b6a0e;font-size:16px;}
.radius-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px;}
.btn-chip{border:none;border-radius:999px;padding:12px 14px;background:#eef6ff;color:#0369a1;font-weight:800;cursor:pointer;transition:all 0.2s;}
.btn-chip[data-active="1"]{background:var(--brand);color:#fff;}
.row{display:flex;justify-content:space-between;align-items:center;padding:14px;border-radius:16px;background:#fff;border:1px solid #eaf1fb;margin-top:10px;}
.total{font-size:18px;font-weight:900;}
.cta{position:fixed;inset-inline:0;bottom:0;background:var(--glass);backdrop-filter:blur(12px);border-top:1px solid #e6edf7;}
.cta .inner{max-width:480px;margin:0 auto;display:flex;gap:10px;padding:12px 16px;}
.btn{appearance:none;border:none;border-radius:14px;padding:14px 16px;font-weight:900;cursor:pointer;}
.btn-black{background:#111;color:#fff;transition:all 0.2s;}
.btn-black:hover{background:#333;}
.btn-ghost{background:#eaf6ff;color:#075985;transition:all 0.2s;}
.btn-ghost:hover{background:#cce6ff;}
.landing{position:relative;min-height:100dvh;padding:24px 16px 120px;display:flex;flex-direction:column;justify-content:space-between;background:radial-gradient(120% 100% at 50% 0%, #eaf6ff 0%, #f7fbff 60%, transparent 100%);}
.landing-head{display:flex;align-items:center;justify-content:space-between;}
.brand-mini{display:flex;align-items:center;gap:10px;font-weight:900;}
.brand-mini .dot{width:14px;height:14px;border-radius:50%;background:linear-gradient(135deg,#76d2ff,#2fb6ff);box-shadow:0 6px 12px #2fb6ff55;}
.how{color:#075985;text-decoration:underline;font-weight:700;}
.landing-center{text-align:center;margin-top:8vh;}
.hero-title{font-size:clamp(22px,5.2vw,32px);line-height:1.15;margin:0;}
.hero-sub{color:var(--muted);margin:.5rem 0 1.1rem;}
.badges{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-bottom:1.1rem;}
.badge{padding:10px 12px;border-radius:999px;border:1px solid #e6edf7;background:#fff;box-shadow:0 8px 18px #0b3b6a12;font-weight:700;}
.skeleton{position:relative;overflow:hidden;background:#eef2f7;border-radius:16px;}
.skeleton::after{content:"";position:absolute;inset:0;transform:translateX(-100%);background:linear-gradient(90deg,transparent,#ffffff66,transparent);animation:shimmer 1.4s infinite;}
@keyframes shimmer{0%{transform:translateX(-100%);}100%{transform:translateX(100%);}}
a{color:#075985;}
details>summary{cursor:pointer;}
.pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef6ff;color:#075985;font-size:12px;font-weight:700;}
.small{font-size:12px;}
.good{color:var(--success);font-weight:800;}
.bad{color:var(--error);font-weight:800;}
.toggle{display:flex;align-items:center;gap:8px;margin-top:8px;}
</style>
</head>
<body>
<div class="app">

<!-- Screen 1: Landing -->
<section id="s1" class="screen active">
  <div class="landing">
    <header class="landing-head">
      <div class="brand-mini"><div class="dot"></div><span>CartCompare <b>AI</b></span></div>
      <a class="how" href="javascript:void(0)" id="howLink">××™×š ×–×” ×¢×•×‘×“?</a>
    </header>
    <div class="landing-center">
      <h1 class="hero-title">××¦×/×™ ××ª ×¡×œ ×”×§× ×™×•×ª ×”×–×•×œ ×œ×™×“×š</h1>
      <p class="hero-sub">××•×¦× ××ª ×”×–×•×œ ×‘××”×™×¨×•×ª ×‘×××¦×¢×•×ª AI</p>
      <div class="badges">
        <span class="badge">âš¡ ×—×•×¡×š ×–××Ÿ</span>
        <span class="badge">ğŸ’¸ ××—×™×¨ ×”×›×™ ×–×•×œ</span>
        <span class="badge">AI ğŸ¤–</span>
      </div>
      <button id="startBtn" class="btn btn-black hero-cta">×‘×•××• × ×ª×—×™×œ</button>
      <button id="gpsSoon" class="btn btn-ghost hero-ghost">×©×™××•×© ×‘-GPS (×‘×§×¨×•×‘)</button>
    </div>
  </div>
</section>

<!-- Screen 2: Address -->
<section id="s2" class="screen">
  <div class="page">
    <div class="box">
      <div style="font-weight:800;font-size:20px">××” ×”×›×ª×•×‘×ª ×©×œ×š?</div>
      <div class="muted" style="margin-top:6px">××¤×©×¨ ×œ×›×ª×•×‘ ×¢×™×¨/×¨×—×•×‘. (×‘×¢×ª×™×“: GPS)</div>
      <div class="input" style="margin-top:12px">
        <label class="muted" for="address">×›×ª×•×‘×ª / ×¢×™×¨</label>
        <input id="address" placeholder="×œ××©×œ: ×—×•×œ×•×Ÿ, ×¡×•×§×•×œ×•×‘ 10" />
      </div>
    </div>
  </div>
</section>

<!-- Screen 3: Radius -->
<section id="s3" class="screen">
  <div class="page">
    <div class="box">
      <div style="font-weight:800;font-size:20px">×¨×“×™×•×¡ ×—×™×¤×•×©</div>
      <div class="muted" style="margin-top:6px">×‘×—×¨/×™ ×›××” ×§×´× ××¡×‘×™×‘ ×œ×›×ª×•×‘×ª</div>
      <div class="radius-grid">
        <button class="btn-chip" type="button" data-radius="2">2 ×§×´×</button>
        <button class="btn-chip" type="button" data-radius="5">5 ×§×´×</button>
        <button class="btn-chip" type="button" data-radius="10">10 ×§×´×</button>
        <button class="btn-chip" type="button" data-radius="15">15 ×§×´×</button>
      </div>
      <div class="input">
        <label class="muted" for="radius">××• ×”×–×Ÿ/×™ ×™×“× ×™×ª</label>
        <input id="radius" type="number" min="1" step="0.5" placeholder="5" />
      </div>
    </div>
  </div>
</section>

<!-- Screen 4: List -->
<section id="s4" class="screen">
  <div class="page">
    <div class="box">
      <div style="font-weight:800;font-size:20px">××” ×ª×¨×¦×” ×œ×§× ×•×ª?</div>
      <div class="muted" style="margin-top:6px">×˜×§×¡×˜ ×—×•×¤×©×™. ×”-AI ×™×‘×™×Ÿ ××•×¦×¨×™× ×•×›××•×™×•×ª.</div>
      <div class="input" style="margin-top:12px">
        <textarea id="list" rows="5" placeholder="×œ××©×œ: ×©×™×©×™×™×ª ××™ ×¢×“×Ÿ 1.5 ×œ×³, ×—×–×” ×¢×•×£ 1 ×§×´×’, 2 ×§×•×§×” ×§×•×œ×” 1.5 ×œ×³"></textarea>
      </div>
      <div class="toggle">
        <input type="checkbox" id="verifiedOnly" checked />
        <label for="verifiedOnly">×”×¦×’ ×¨×§ ×—× ×•×™×•×ª ×××•××ª×•×ª</label>
      </div>
    </div>
  </div>
</section>

<!-- Screen 5: Results -->
<section id="s5" class="screen">
  <div class="page">
    <div class="box">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:800;font-size:20px">×”×ª×•×¦××•×ª</div>
        <span class="pill">OpenAI web_search</span>
      </div>
      <div id="summary" class="muted" style="margin-top:6px"></div>
      <div id="results" style="margin-top:12px"></div>
      <div id="loading" class="skeleton" style="height:64px;margin-top:12px;display:none"></div>
      <div id="debugWrap" style="display:none;margin-top:12px">
        <details><summary>ğŸ”§ Debug</summary><pre id="debugJson" class="debug"></pre></details>
      </div>
    </div>
  </div>
</section>

<div class="cta">
  <div class="inner">
    <button id="back" class="btn btn-ghost" type="button">×—×–×¨×”</button>
    <button id="next" class="btn btn-black" type="button">×”×‘×</button>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const screens = ['s1','s2','s3','s4','s5'].map(id=>document.getElementById(id));
  let step = 0;
  const btnNext = document.getElementById('next');
  const btnBack = document.getElementById('back');
  const startBtn = document.getElementById('startBtn');
  const howLink = document.getElementById('howLink');
  const gpsSoon = document.getElementById('gpsSoon');

  const addressEl = document.getElementById('address');
  const radiusEl = document.getElementById('radius');
  const listEl = document.getElementById('list');
  const verifiedOnlyEl = document.getElementById('verifiedOnly');

  const resultsEl = document.getElementById('results');
  const loadingEl = document.getElementById('loading');
  const summaryEl = document.getElementById('summary');
  const debugWrap = document.getElementById('debugWrap');
  const debugJson = document.getElementById('debugJson');
  const isDebug = new URLSearchParams(location.search).get('debug') === '1';

  function goto(n){
    step = Math.max(0, Math.min(4, n));
    screens.forEach((s,i)=> s.classList.toggle('active', i===step));
    btnBack.textContent = step===0 ? '×™×¦×™××”' : '×—×–×¨×”';
    btnNext.textContent = step===4 ? '×—×¤×© ×¢×›×©×™×•' : '×”×‘×';
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
  goto(0);

  startBtn?.addEventListener('click', ()=> goto(1));
  howLink?.addEventListener('click', ()=> goto(1));
  gpsSoon?.addEventListener('click', ()=> alert('×©×™××•×© ×‘-GPS ×™×ª×•×•×¡×£ ×‘×§×¨×•×‘ ğŸ˜Š'));

  document.querySelectorAll('[data-radius]').forEach(b=>{
    b.addEventListener('click', ()=>{
      document.querySelectorAll('[data-radius]').forEach(x=>x.dataset.active="0");
      b.dataset.active="1";
      radiusEl.value = b.getAttribute('data-radius');
      goto(step+1);
    });
  });

  btnBack.addEventListener('click', ()=>{ if(step===0){ return; } goto(step-1); });

  btnNext.addEventListener('click', async ()=>{
    if(step===1){ if(!addressEl.value.trim()) return shake(addressEl); return goto(step+1); }
    if(step===2){ if(!radiusEl.value) return shake(radiusEl); return goto(step+1); }
    if(step===3){ if(!listEl.value.trim()) return shake(listEl); return goto(step+1); }
    if(step<4) return goto(step+1);

    // Run search
    renderSkeleton();
    debugWrap.style.display = isDebug ? 'block' : 'none';
    debugJson.textContent = '';

    const payload = {
      address: addressEl.value.trim(),
      radius_km: Number(radiusEl.value || 5),
      list_text: listEl.value.trim(),
      show_all: !verifiedOnlyEl.checked ? true : false,
      include_debug: isDebug
    };

    summaryEl.textContent = `×›×ª×•×‘×ª: ${payload.address} â€¢ ×¨×“×™×•×¡: ${payload.radius_km} ×§×´× â€¢ ××•×¦×¨×™×: ${payload.list_text.split(/\s+/).length} ××™×œ×™×`;

    try{
      const res = await fetch('/api/search', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await res.json();

      loadingEl.style.display = 'none';
      if (isDebug) debugJson.textContent = JSON.stringify(data, null, 2);

      if(!res.ok){
        resultsEl.innerHTML = row(`×©×’×™××ª ×©×¨×ª (${res.status})`, data.message || '×œ× ×™×“×•×¢');
        console.error("API error", data);
        return;
      }
      if(data.status!=='ok' || !Array.isArray(data.results) || data.results.length===0){
        resultsEl.innerHTML = row('×œ× × ××¦××• ×ª×•×¦××•×ª', data.message || '× ×¡×• ×œ×“×™×™×§ ××•×ª×’/× ×¤×—, ×œ×”×’×“×™×œ ×¨×“×™×•×¡, ××• ×œ× ×¡×•×ª ××™×§×•× ×¡××•×š');
        return;
      }

      resultsEl.innerHTML = data.results.map(renderStore).join('');

    }catch(err){
      loadingEl.style.display = 'none';
      resultsEl.innerHTML = row('×©×’×™××ª ×¨×©×ª', err.message || String(err));
      console.error("Network error", err);
    }
  });

  function renderStore(r){
    const total = toPrice(r.total_price, r.currency || "â‚ª");
    const mo = (typeof r.match_overall === 'number') ? `${Math.round(r.match_overall*100)}%` : 'â€”';
    const cover = (typeof r.coverage === 'number') ? `${Math.round(r.coverage*100)}%` : 'â€”';
    const verified = r.store_verification?.store_verified;
    const badge = verified ? `<span class="pill good">×××•××ª</span>` : `<span class="pill bad">×œ× ×××•××ª</span>`;
    const basketRows = Array.isArray(r.basket) ? r.basket.map(renderBasketItem.bind(null,r.currency)).join('') : '';

    const hdr = `
    <div class="row">
      <div>
        <div><strong>#${esc(r.rank||'?')} â€” ${esc(r.store_name||'')}</strong> ${badge}</div>
        <div class="muted small">${esc(r.branch_name||'')} â€¢ ${esc(r.address||'')} â€¢ ${esc(r.distance_km||'')} ×§×´× â€¢ ×“×™×•×§ ×›×œ×œ×™ ${mo} â€¢ ×›×™×¡×•×™ ${cover}</div>
        ${r.branch_url ? `<div class="small"><a href="${escAttr(r.branch_url)}" target="_blank" rel="noopener">×“×£ ×”×¡× ×™×£ / ××¤×•×ª</a></div>` : ''}
        ${r.notes ? `<div class="muted small">${esc(r.notes)}</div>` : ''}
      </div>
      <div class="total">${total}</div>
    </div>
    `;

    return hdr + `<details class="box" style="margin-top:10px"><summary>×¤×™×¨×•×˜ ×¡×œ</summary><div style="height:8px"></div>${basketRows}</details>`;
  }

  function renderBasketItem(currency,b){
    const unit = toPrice(b.unit_price, currency);
    const line = toPrice(b.line_total, currency);
    const brand = b.brand ? ` <span class="muted">â€¢ ${esc(b.brand)}</span>` : '';
    const src = b.product_url ? `<div class="muted"><a href="${escAttr(b.product_url)}" target="_blank" rel="noopener">××§×•×¨</a>${b.source_domain? ' â€¢ '+esc(b.source_domain):''}${b.observed_price_text? ' â€¢ '+esc(b.observed_price_text): ''}</div>` : '';
    const v = b.verification || {};
    const vline = `<div class="small ${v.notes==='OK'?'good':'bad'}">
      ××™××•×ª: ×“×•××™×™×Ÿ ${v.domain_ok?'âœ…':'âŒ'} â€¢ ×¡×˜×˜×•×¡ ${v.http_status||0} â€¢ â‚ª/${v.price_source||'-'} ${v.found_shekel?'âœ…':'âŒ'} â€¢ ×”×ª×××ª ××—×™×¨ ${v.price_matches?'âœ…':'âŒ'} â€¢ ×”×ª×××ª ×©× ~${Math.round((v.name_match||0)*100)}%</div>`;
    return `<div class="row"><div>${esc(b.name)}${brand}${src}${isDebug?vline:''}</div><div>${line}</div></div>`;
  }

  function toPrice(num,cur="â‚ª"){
    if(num==null) return 'â€”';
    return `${cur} ${Number(num).toFixed(2)}`;
  }

  function esc(s){return String(s||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
  function escAttr(s){return String(s||'').replace(/"/g,'&quot;');}

  function renderSkeleton(){
    resultsEl.innerHTML = '';
    loadingEl.style.display = 'block';
  }

  function shake(el){
    el.style.transition = 'transform 0.15s';
    el.style.transform='translateX(8px)';
    setTimeout(()=>el.style.transform='translateX(-8px)',150);
    setTimeout(()=>el.style.transform='translateX(0)',300);
  }
});
</script>
</body>
</html>
