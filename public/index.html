<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>השוואת סל – הכל ע״י AI</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 2rem; }
    .row { display: flex; gap: .75rem; margin-bottom: .75rem; }
    input, textarea, button { padding: .6rem; font-size: 1rem; }
    textarea { width: 100%; height: 8rem; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 1rem; margin-top: 1rem; }
    .btn { background: black; color: white; border: none; border-radius: 8px; cursor: pointer; }
    .muted { color: #666; font-size: .9rem; }
    table { width: 100%; border-collapse: collapse; margin-top: .5rem;}
    th, td { border-bottom: 1px solid #eee; padding: .5rem .25rem; text-align: start; }
    .link { color: #0066cc; cursor: pointer; text-decoration: underline; }
    .grid { display: grid; grid-template-columns: 1fr auto; align-items: center; }
  </style>
</head>
<body>
  <h1>השוואת סל – הכל ע״י AI</h1>
  <div class="row">
    <input id="address" placeholder="עיר / כתובת (למשל: בן יהודה 32, תל אביב)" style="flex:2" />
    <input id="radius" type="number" min="1" step="1" value="5" style="width:8rem" />
    <button class="btn" id="run">מצא לי את הזול</button>
  </div>
  <textarea id="items" placeholder="רשימת קניות (שורה לכל פריט; כמות אופציונלית עם ;qty)
חלב 3% 1 ל';2
לחם פרוס;1
ביצים L תריסר;1"></textarea>

  <div id="results"></div>

  <script type="module">
    const qs = s => document.querySelector(s);

    function renderResults(json) {
      const el = qs('#results');
      el.innerHTML = '';
      if (!json) return;

      if (json.status === 'need_input') {
        el.innerHTML = `<div class="card">חסר מידע: ${json.needed?.join(', ') || ''}</div>`;
        return;
      }
      if (json.status === 'no_results') {
        el.innerHTML = `<div class="card">לא נמצאו סניפים או נתונים מתאימים.</div>`;
        return;
      }
      if (json.status !== 'ok') {
        el.innerHTML = `<div class="card">שגיאה: <pre>${JSON.stringify(json, null, 2)}</pre></div>`;
        return;
      }

      const list = document.createElement('div');
      json.results.slice(0,3).forEach(r => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="grid">
            <div>
              <div><b>${r.rank}. ${r.chain}</b> — ${r.branch_name}</div>
              <div class="muted">${r.distance_km} ק״מ • ${Number(r.total_price).toFixed(2)} ₪</div>
            </div>
            <div><span class="link" data-branch="${r.branch_id}">פירוט מחירים</span></div>
          </div>
        `;
        card.querySelector('[data-branch]').addEventListener('click', async () => {
          const resp = await fetch('/api/details', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ branch_id: r.branch_id })
          });
          const det = await resp.json();
          const holder = document.createElement('div');
          if (!det || !det.items) {
            holder.innerHTML = `<div class="muted">אין פירוט זמין.</div>`;
          } else {
            holder.innerHTML = `
              <table>
                <thead><tr><th>מבוקש</th><th>התאמה</th><th>מחיר</th><th>כמות</th><th>סכום</th></tr></thead>
                <tbody>
                  ${det.items.map(it => `
                    <tr>
                      <td>${it.requested}</td>
                      <td>${it.matched_sku}</td>
                      <td>${Number(it.unit_price).toFixed(2)} ₪</td>
                      <td>${it.qty}</td>
                      <td>${Number(it.line_total).toFixed(2)} ₪</td>
                    </tr>`).join('')}
                </tbody>
              </table>
              <div style="margin-top:.5rem"><b>סה״כ:</b> ${Number(det.total_price).toFixed(2)} ₪</div>
            `;
          }
          const old = card.querySelector('.details');
          if (old) old.remove();
          const wrap = document.createElement('div');
          wrap.className = 'details';
          wrap.appendChild(holder);
          card.appendChild(wrap);
        });
        list.appendChild(card);
      });
      el.appendChild(list);
    }

    qs('#run').addEventListener('click', async () => {
      const address = qs('#address').value.trim();
      const radius_km = Number(qs('#radius').value);
      const items = qs('#items').value.split('\n').map(s => s.trim()).filter(Boolean);

      qs('#results').innerHTML = '<div class="card">טוען…</div>';

      const resp = await fetch('/api/search', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ address, radius_km, items })
      });
      const json = await resp.json();
      renderResults(json);
    });
  </script>
</body>
</html>
